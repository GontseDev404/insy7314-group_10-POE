version: 2.1

jobs:
  backend-validation:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Check for package.json
          command: |
            if [ ! -f SecurePaymentsAPI/package.json ]; then
              echo "Error: package.json not found in SecurePaymentsAPI directory"
              ls -R
              exit 1
            fi
            echo "✓ package.json found"
            cat SecurePaymentsAPI/package.json
      - run:
          name: Install dependencies
          command: |
            cd SecurePaymentsAPI
            npm ci
      - run:
          name: Syntax validation
          command: |
            echo "Validating JavaScript syntax..."
            find SecurePaymentsAPI -name "*.js" -not -path "*/node_modules/*" -exec node -c {} \;
            echo "✓ All JavaScript files have valid syntax"
      - run:
          name: Security audit
          command: |
            cd SecurePaymentsAPI
            echo "Running npm audit..."
            npm audit --audit-level=moderate || true
            echo "✓ Security audit completed"

  frontend-validation:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Check for package.json
          command: |
            if [ ! -f SecurePaymentsFrontend/package.json ]; then
              echo "Error: package.json not found in SecurePaymentsFrontend directory"
              ls -R
              exit 1
            fi
            echo "✓ package.json found"
            cat SecurePaymentsFrontend/package.json
      - run:
          name: Install dependencies
          command: |
            cd SecurePaymentsFrontend
            npm ci
      - run:
          name: ESLint check
          command: |
            cd SecurePaymentsFrontend
            npm run lint
      - run:
          name: Build frontend
          command: |
            cd SecurePaymentsFrontend
            npm run build
      - run:
          name: Security audit
          command: |
            cd SecurePaymentsFrontend
            echo "Running npm audit..."
            npm audit --audit-level=moderate || true
            echo "✓ Security audit completed"

  sonarqube-backend:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Check SonarQube Configuration
          command: |
            if [ -z "${SONAR_HOST_URL}" ] || [ -z "${SONAR_TOKEN}" ]; then
              echo "⚠️  SonarQube environment variables not set. Skipping SonarQube analysis."
              echo "To enable SonarQube analysis, set the following in CircleCI project settings:"
              echo "  - SONAR_HOST_URL: Your SonarQube server URL"
              echo "  - SONAR_TOKEN: Your SonarQube authentication token"
              echo "See README.md for setup instructions."
              circleci-agent step halt
            fi
      - run:
          name: Install SonarQube Scanner
          command: |
            curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip -q sonar-scanner.zip
            export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin)"
            echo 'export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"' >> $BASH_ENV
      - run:
          name: Install dependencies
          command: |
            cd SecurePaymentsAPI
            npm ci
      - run:
          name: SonarQube Analysis (Backend)
          command: |
            cd SecurePaymentsAPI
            # Build project key with organization if provided
            if [ -n "${SONAR_ORG_KEY}" ]; then
              PROJECT_KEY="${SONAR_ORG_KEY}_secure-payments-api"
            else
              PROJECT_KEY="secure-payments-api"
            fi
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.projectKey="${PROJECT_KEY}" \
              -Dsonar.projectName="Secure Payments API" \
              -Dsonar.sources=. \
              -Dsonar.exclusions="node_modules/**,**/node_modules/**,certs/**,*.db,*.log" \
              -Dsonar.sourceEncoding=UTF-8

  sonarqube-frontend:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Check SonarQube Configuration
          command: |
            if [ -z "${SONAR_HOST_URL}" ] || [ -z "${SONAR_TOKEN}" ]; then
              echo "⚠️  SonarQube environment variables not set. Skipping SonarQube analysis."
              echo "To enable SonarQube analysis, set the following in CircleCI project settings:"
              echo "  - SONAR_HOST_URL: Your SonarQube server URL"
              echo "  - SONAR_TOKEN: Your SonarQube authentication token"
              echo "See README.md for setup instructions."
              circleci-agent step halt
            fi
      - run:
          name: Install SonarQube Scanner
          command: |
            curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip -q sonar-scanner.zip
            export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin)"
            echo 'export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"' >> $BASH_ENV
      - run:
          name: Install dependencies
          command: |
            cd SecurePaymentsFrontend
            npm ci
      - run:
          name: SonarQube Analysis (Frontend)
          command: |
            cd SecurePaymentsFrontend
            # Build project key with organization if provided
            if [ -n "${SONAR_ORG_KEY}" ]; then
              PROJECT_KEY="${SONAR_ORG_KEY}_secure-payments-frontend"
            else
              PROJECT_KEY="secure-payments-frontend"
            fi
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.projectKey="${PROJECT_KEY}" \
              -Dsonar.projectName="Secure Payments Frontend" \
              -Dsonar.sources=src \
              -Dsonar.exclusions="node_modules/**,dist/**,build/**,**/node_modules/**,public/**" \
              -Dsonar.sourceEncoding=UTF-8

workflows:
  version: 2
  build-and-analyze:
    jobs:
      - backend-validation
      - frontend-validation
      - sonarqube-backend:
          requires:
            - backend-validation
          filters:
            branches:
              only:
                - main
                - master
      - sonarqube-frontend:
          requires:
            - frontend-validation
          filters:
            branches:
              only:
                - main
                - master
