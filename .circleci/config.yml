version: 2.1

jobs:
  backend-validation:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project/SecurePaymentsAPI
    steps:
      - checkout
      - run:
          name: Check for package.json
          command: |
            if [ ! -f package.json ]; then
              echo "Error: package.json not found in SecurePaymentsAPI directory"
              exit 1
            fi
            echo "✓ package.json found"
            cat package.json
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Syntax validation
          command: |
            echo "Validating JavaScript syntax..."
            find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;
            echo "✓ All JavaScript files have valid syntax"
      - run:
          name: Security audit
          command: |
            echo "Running npm audit..."
            npm audit --audit-level=moderate || true
            echo "✓ Security audit completed"

  frontend-validation:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project/SecurePaymentsFrontend
    steps:
      - checkout
      - run:
          name: Check for package.json
          command: |
            if [ ! -f package.json ]; then
              echo "Error: package.json not found in SecurePaymentsFrontend directory"
              exit 1
            fi
            echo "✓ package.json found"
            cat package.json
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: ESLint check
          command: npm run lint
      - run:
          name: Build frontend
          command: npm run build
      - run:
          name: Security audit
          command: |
            echo "Running npm audit..."
            npm audit --audit-level=moderate || true
            echo "✓ Security audit completed"

  sonarqube-backend:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project/SecurePaymentsAPI
    steps:
      - checkout
      - run:
          name: Install SonarQube Scanner
          command: |
            curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip -q sonar-scanner.zip
            export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin)"
            echo 'export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"' >> $BASH_ENV
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: SonarQube Analysis (Backend)
          command: |
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.projectKey=secure-payments-api \
              -Dsonar.projectName="Secure Payments API" \
              -Dsonar.sources=. \
              -Dsonar.exclusions="node_modules/**,**/node_modules/**,certs/**,*.db,*.log" \
              -Dsonar.sourceEncoding=UTF-8

  sonarqube-frontend:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/project/SecurePaymentsFrontend
    steps:
      - checkout
      - run:
          name: Install SonarQube Scanner
          command: |
            curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
            unzip -q sonar-scanner.zip
            export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin)"
            echo 'export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"' >> $BASH_ENV
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: SonarQube Analysis (Frontend)
          command: |
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.projectKey=secure-payments-frontend \
              -Dsonar.projectName="Secure Payments Frontend" \
              -Dsonar.sources=src \
              -Dsonar.exclusions="node_modules/**,dist/**,build/**,**/node_modules/**,public/**" \
              -Dsonar.sourceEncoding=UTF-8

workflows:
  version: 2
  build-and-analyze:
    jobs:
      - backend-validation
      - frontend-validation
      - sonarqube-backend:
          requires:
            - backend-validation
          filters:
            branches:
              only:
                - main
                - master
      - sonarqube-frontend:
          requires:
            - frontend-validation
          filters:
            branches:
              only:
                - main
                - master
